name: CI
on: [push, pull_request]

jobs:
  all:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - name: Build & start app
        run: |
          docker compose build web
          docker compose up -d web

      - name: Unit (HTML only)
        run: |
          npm ci
          npm test
        continue-on-error: true

      - name: UI (Playwright + Allure)
        run: docker compose run --rm e2e
        continue-on-error: true

      - name: API (Newman + Allure)
        run: docker compose run --rm newman
        continue-on-error: true

      # --- Always generate Allure, even when no results or tests failed ---
      - name: Ensure at least one allure-results dir exists
        if: always()
        run: |
          shopt -s nullglob
          matches=(reports/**/allure-results/*)
          if [ ${#matches[@]} -eq 0 ]; then
            mkdir -p reports/placeholder/allure-results
            # minimal fake container.json so Allure doesn't error on empty input
            echo '{"reportName":"Empty Report","testRuns":[]}' > reports/placeholder/allure-results/container.json
          fi

      - name: Generate Allure dashboard
        if: always()
        run: npx -y allure-commandline generate "reports/**/allure-results" -o "reports/allure-report" --clean

      - name: Upload Allure dashboard
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-dashboard
          path: reports/allure-report

      - name: Upload suite reports (HTML/JSON)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: suite-reports
          path: |
            reports/jest/html
            reports/playwright/html
            reports/newman/html
            reports/k6
          if-no-files-found: ignore

      - name: Cleanup
        if: always()
        run: docker compose down -v